name: "Check Doxygen Documentation"

#  This file is part of t8code.
#  t8code is a C library to manage a collection (a forest) of multiple
#  connected adaptive space-trees of general element types in parallel.
#
#  Copyright (C) 2025 the developers
#
#  t8code is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#
#  t8code is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with t8code; if not, write to the Free Software Foundation, Inc.,
#  51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.

#
# This github CI script runs on every push on a feature branch and in the merge queue.
# It checks if the doxygen documentation can be built without errors and warnings.
#

on:
  workflow_call:

  # Allows you to run this workflow manually from the actions tab
  workflow_dispatch:

jobs:
  update_dev_doc:
    runs-on: ubuntu-latest
    container: dlramr/t8code-ubuntu:t8-dependencies
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v5    
      with:
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        ref: ${{ github.event.pull_request.head.ref }}
        fetch-depth: 0
    - name: disable ownership checks
      run: git config --global --add safe.directory '*'
    - name: init submodules
      run: git submodule init
    - name: update submodules
      run: git submodule update
    - name: Install LaTeX dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          texlive-latex-base \
          texlive-latex-recommended \
          texlive-latex-extra \
          texlive-fonts-recommended \
          texlive-font-utils \
          ghostscript
    - name: Which epstopdf
      run: which epstopdf 
    - name: Download precompiled doxygen version 1.13.2 from official website
      run: wget https://www.doxygen.nl/files/doxygen-1.13.2.linux.bin.tar.gz
    - name: Unpack doxygen tar file
      run: |
        tar xf doxygen-1.13.2.linux.bin.tar.gz 
        mv doxygen-1.13.2/bin/doxygen ./doxygen
        chmod +x ./doxygen
        echo "$PWD" >> $GITHUB_PATH
    - name: Echo doxygen executable and version
      run: | 
        which doxygen
        doxygen --version
    - name: build config variables
      run: export CONFIG_OPTIONS="-DT8CODE_BUILD_DOCUMENTATION=ON -DCMAKE_BUILD_TYPE=Debug -DT8CODE_ENABLE_VTK=ON -DVTK_DIR=/usr/local/lib/cmake/vtk-9.1 -DT8CODE_ENABLE_OCC=ON -DT8CODE_ENABLE_NETCDF=ON"
        && echo CONFIG_OPTIONS="$CONFIG_OPTIONS" >> $GITHUB_ENV
    - name: Configure for documentation only
      run: mkdir build && cd build && cmake ../ $CONFIG_OPTIONS
    - name: OnFailUploadLog
      if: failure()
      uses: actions/upload-artifact@v5
      with:
        name: cmake_doc_build.log
        path: build/config.log
    - name: check doxygen for errors / warnings
      run: |
        cd build && cd doc 
        doxygen Doxyfile >> doxygen.out 2> doxygen.err
    - name: Upload doxygen log
      if: failure()
      uses: actions/upload-artifact@v5
      with:
        name: doxygen-log
        path: build/doc/doxygen.err

