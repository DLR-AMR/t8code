add_library( gtest ${CMAKE_CURRENT_LIST_DIR}/../thirdparty/googletest-mpi/gtest/gtest-all.cc )
target_include_directories( gtest PUBLIC ${CMAKE_CURRENT_LIST_DIR}/../thirdparty/googletest-mpi ${CMAKE_CURRENT_LIST_DIR}/.. )

function( add_t8_test )
    set( options "" )
    set( oneValueArgs "NAME" )  
    set( multiValueArgs "SOURCES" )
    cmake_parse_arguments( ADD_T8_TEST "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN} )

    add_executable( ${ADD_T8_TEST_NAME} ${ADD_T8_TEST_SOURCES} )
    target_link_libraries( ${ADD_T8_TEST_NAME} PRIVATE T8 gtest )
    add_test( NAME ${ADD_T8_TEST_NAME} COMMAND ./${ADD_T8_TEST_NAME} )
endfunction()

# Copy test files to build folder so that the t8_test programs can find them.
function( copy_test_file TEST_FILE_NAME )
    configure_file(${CMAKE_CURRENT_LIST_DIR}/testfiles/${TEST_FILE_NAME} ${CMAKE_CURRENT_BINARY_DIR}/test/testfiles/${TEST_FILE_NAME} COPYONLY)
endfunction()

add_t8_test( NAME t8_gtest_cmesh_bcast       SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_bcast.cxx )
add_t8_test( NAME t8_gtest_eclass            SOURCES t8_gtest_main.cxx t8_gtest_eclass.cxx )
add_t8_test( NAME t8_gtest_vec               SOURCES t8_gtest_main.cxx t8_gtest_vec.cxx )
add_t8_test( NAME t8_gtest_mat               SOURCES t8_gtest_main.cxx t8_gtest_mat.cxx )
add_t8_test( NAME t8_gtest_refcount          SOURCES t8_gtest_main.cxx t8_gtest_refcount.cxx )
add_t8_test( NAME t8_gtest_occ_linkage       SOURCES t8_gtest_main.cxx t8_gtest_occ_linkage.cxx )
add_t8_test( NAME t8_gtest_version           SOURCES t8_gtest_main.cxx t8_gtest_version.cxx )
add_t8_test( NAME t8_gtest_basics            SOURCES t8_gtest_main.cxx t8_gtest_basics.cxx )
add_t8_test( NAME t8_gtest_netcdf_linkage    SOURCES t8_gtest_main.cxx t8_gtest_netcdf_linkage.cxx )
add_t8_test( NAME t8_gtest_vtk_linkage       SOURCES t8_gtest_main.cxx t8_gtest_vtk_linkage.cxx )

add_t8_test( NAME t8_gtest_hypercube                     SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_hypercube.cxx )
add_t8_test( NAME t8_gtest_cmesh_copy                    SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_cmesh_copy.cxx )
add_t8_test( NAME t8_gtest_cmesh_face_is_boundary        SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_cmesh_face_is_boundary.cxx )
add_t8_test( NAME t8_gtest_cmesh_partition               SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_cmesh_partition.cxx )
add_t8_test( NAME t8_gtest_cmesh_set_partition_offsets   SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_cmesh_set_partition_offsets.cxx )
add_t8_test( NAME t8_gtest_cmesh_set_join_by_vertices    SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_cmesh_set_join_by_vertices.cxx )
add_t8_test( NAME t8_gtest_multiple_attributes           SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_multiple_attributes.cxx )
add_t8_test( NAME t8_gtest_attribute_gloidx_array        SOURCES t8_gtest_main.cxx t8_cmesh/t8_gtest_attribute_gloidx_array.cxx )

add_t8_test( NAME t8_gtest_shmem SOURCES t8_gtest_main.cxx t8_data/t8_gtest_shmem.cxx )

add_t8_test( NAME t8_gtest_element_volume            SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_element_volume.cxx )
add_t8_test( NAME t8_gtest_search                    SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_search.cxx )
add_t8_test( NAME t8_gtest_half_neighbors            SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_half_neighbors.cxx )
add_t8_test( NAME t8_gtest_find_owner                SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_find_owner.cxx )
add_t8_test( NAME t8_gtest_user_data                 SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_user_data.cxx )
add_t8_test( NAME t8_gtest_transform                 SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_transform.cxx )
add_t8_test( NAME t8_gtest_ghost_exchange            SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_ghost_exchange.cxx )
add_t8_test( NAME t8_gtest_ghost_delete              SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_ghost_delete.cxx )
add_t8_test( NAME t8_gtest_ghost_and_owner           SOURCES t8_gtest_main.cxx t8_forest/t8_gtest_ghost_and_owner.cxx )

add_t8_test( NAME t8_gtest_permute_hole      SOURCES t8_gtest_main.cxx t8_forest_incomplete/t8_gtest_permute_hole.cxx )
add_t8_test( NAME t8_gtest_recursive         SOURCES t8_gtest_main.cxx t8_forest_incomplete/t8_gtest_recursive.cxx )
add_t8_test( NAME t8_gtest_iterate_replace   SOURCES t8_gtest_main.cxx t8_forest_incomplete/t8_gtest_iterate_replace.cxx )
add_t8_test( NAME t8_gtest_empty_local_tree  SOURCES t8_gtest_main.cxx t8_forest_incomplete/t8_gtest_empty_local_tree.cxx )
add_t8_test( NAME t8_gtest_empty_global_tree SOURCES t8_gtest_main.cxx t8_forest_incomplete/t8_gtest_empty_global_tree.cxx )

add_t8_test( NAME t8_gtest_geometry_cad         SOURCES t8_gtest_main.cxx t8_geometry/t8_geometry_implementations/t8_gtest_geometry_cad.cxx )
add_t8_test( NAME t8_gtest_geometry_linear      SOURCES t8_gtest_main.cxx t8_geometry/t8_geometry_implementations/t8_gtest_geometry_linear.cxx )
add_t8_test( NAME t8_gtest_geometry_handling    SOURCES t8_gtest_main.cxx t8_geometry/t8_gtest_geometry_handling.cxx )
add_t8_test( NAME t8_gtest_point_inside         SOURCES t8_gtest_main.cxx t8_geometry/t8_gtest_point_inside.cxx )

add_t8_test( NAME t8_gtest_vtk_reader SOURCES t8_gtest_main.cxx t8_IO/t8_gtest_vtk_reader.cxx )

add_t8_test( NAME t8_gtest_nca                   SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_nca.cxx )
add_t8_test( NAME t8_gtest_pyra_connectivity     SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_pyra_connectivity.cxx )
add_t8_test( NAME t8_gtest_face_neigh            SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_face_neigh.cxx )
add_t8_test( NAME t8_gtest_init_linear_id        SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_init_linear_id.cxx )
add_t8_test( NAME t8_gtest_ancestor              SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_ancestor.cxx )
add_t8_test( NAME t8_gtest_element_count_leaves  SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_element_count_leaves.cxx )
add_t8_test( NAME t8_gtest_element_ref_coords    SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_element_ref_coords.cxx )
add_t8_test( NAME t8_gtest_descendant            SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_descendant.cxx )
add_t8_test( NAME t8_gtest_find_parent           SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_find_parent.cxx )
add_t8_test( NAME t8_gtest_equal                 SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_equal.cxx )
add_t8_test( NAME t8_gtest_successor             SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_successor.cxx )
add_t8_test( NAME t8_gtest_boundary_extrude      SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_boundary_extrude.cxx )
add_t8_test( NAME t8_gtest_face_descendant       SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_face_descendant.cxx )
add_t8_test( NAME t8_gtest_default               SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_default.cxx )
add_t8_test( NAME t8_gtest_child_parent_face     SOURCES t8_gtest_main.cxx t8_schemes/t8_gtest_child_parent_face.cxx )

copy_test_file( test_cube_unstructured_1.inp )
copy_test_file( test_cube_unstructured_2.inp )
copy_test_file( test_vtk_tri.vtu )
copy_test_file( test_vtk_cube.vtp )
copy_test_file( test_parallel_file.pvtu )
copy_test_file( test_polydata.pvtp )
